---
title: LinuxKernel以太网接收延迟问题
date: 2021-06-03 10:32:47
tags:
---

问归结到底，是以太网MAC外设的coalesce（合并）问题，下面引用一下IMX6ULL芯片手册对这功能的描述：
```
The purpose of the interrupt coalescing is to reduce the number of interrupts generated by the MAC so as to reduce the CPU loading.
中断合并的目的是减少MAC产生的中断次数，从而降低CPU负载。
```
修改后接收延迟将降低200多us  
内核源码中直接搜索`coalesce`关键词可以找到此类设置  
# IMX6ULL 关闭coalesce方法（使用freescale fec的IC皆可使用此方式）
将drivers/net/ethernet/freescale/fec_main.c文件的
```
rx_itr |= FEC_ITR_EN;
tx_itr |= FEC_ITR_EN;
```
修改为
```
rx_itr &= ~FEC_ITR_EN;
tx_itr &= ~FEC_ITR_EN;
```
disable使能位。

# s5p4418 关闭coalesce方法（使用stmmac的IC皆可使用此方式）
将drivers/net/ethernet/stmicro/stmmac/stmmac_main.c文件的
```
	if ((priv->synopsys_id >= DWMAC_CORE_3_50) && (!priv->plat->riwt_off)) {
		priv->use_riwt = 1;
		pr_info(" Enable RX Mitigation via HW Watchdog Timer\n");
	}
```
下添加
```
priv->use_riwt = 0;
```
失能Rx Watchdog即可。